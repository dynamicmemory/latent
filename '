from src.agent import Agent
from src.sqlitedb import DatabaseManager
import pyfiglet

USERNAME:str = "HUMAN OVERLORD"   # Temp
TIME_MAP: dict[int, str] = { 1: "15", 2: "60", 3: "240", 4: "D", 5: "W", }
ASSET_MAP: dict[int, str] = { 1: "BTCUSDT", }


def print_banner(banner_text:str="SYNTRA SYSTEMS") -> None:
    """
    Clears the terminal display and prints a banner for the current menu
           
    Args:
        banner_text: The text to print inside the banner, default to app name.
    """
    print("\033c", end="")
    text = pyfiglet.figlet_format(banner_text, font="slant")
    print(text)
    print("-"*60)


def run_main_menu() -> None:
    """
    Runs the main menu for the application, delegates duties depending 
    on what the user selects to do, current choices are:
      - 1. Check user accounts for managing and trading  
      - 2. Enter the settings menu 
      - 3. Exiting the application
    """
    options:int = 8
    while True:
        print_banner()
        print(f"Welcome back {USERNAME}, what would you like to do?{main_menu}")
        choice = get_menu_selection(options)

        if choice == 1:                               # Manage account
            print("Feature currently under construction")
            input("\nHit enter to continue")

        elif choice == 2: run_predict()
        elif choice == 3:                              # Start auto 
            print("Feature currently under construction")
            input("\nHit enter to continue")

        elif choice == 4:                              # Stop auto 
            print("Feature currently under construction")
            input("\nHit enter to continue")

        elif choice == 5:                              # View dashoard 
            print("Feature currently under construction")
            input("\nHit enter to continue")

        elif choice == 6: run_maintenance()
        elif choice == 7:                              # Settings 
            print("Feature currently under construction")
            input("\nHit enter to continue")

        elif choice == 8:
            print("\033c", end="")
            exit()


def print_manage_account() -> int:
    # Print all account details
    # 1. Close all trades
    return 1;
def run_manage_accout() -> None:
    pass


def get_menu_selection(options:int) -> int:
    print("-"*60)
    while True:
        try:
            choice = int(input("\n>> "))
        except (ValueError, TypeError):
            print("Enter a number from the provided options")
            continue

        if choice > 0 and choice < options+1:
            return choice 
        print("Enter a number from the provided options")


def print_predict_menu(asset:int|None=None, timeframe:int|None=None):
    disp_asset = None if asset == None else ASSET_MAP[asset]
    disp_tf = None if timeframe == None else TIME_MAP[timeframe]
    
    print_banner("PREDICTION")
    print(f"Current Asset: {disp_asset} | Current Timeframe: {disp_tf}\n")
    print("1. Choose asset")
    print("2. Choose timeframe")
    print("3. Make a prediction")
    print("4. Return to main menu")
    

def run_predict() -> None:
    options:int = 4                            # Number of menu options
    asset:int|None = None
    timeframe:int|None = None
    while True:
        print_predict_menu(asset, timeframe)
        choice = get_menu_selection(options)

        if choice == 1:
            print("\nWhich asset:\n")
            print("1. Bitcoin")
            asset = get_menu_selection(len(ASSET_MAP))

        elif choice == 2:
            print("\nWhich timeframe:\n")
            print("1. 15 minutes")
            print("2. 1 hour")
            print("3. 4 hour")
            print("4. Daily")
            print("5. Weekly")
            timeframe = get_menu_selection(len(TIME_MAP))

        elif choice == 3:
            if asset is None or timeframe is None:
                print("\nError: Select an asset and timeframe to predict on first")
                input("\n>> Hit enter to continue")
                continue
            else:
                Agent(ASSET_MAP[asset], TIME_MAP[timeframe])
                input("\n>> Hit enter to continue")

        elif choice == 4:
            break


def print_maintenance_menu() -> None:
    """ Prints the settings menu for the app """
    print_banner("MAINTENANCE")
    print("Maintenance menu\n")           # Replace this with maintenance info
    print("1. Update database")
    print("2. Retrain models")
    print("3. Return to main menu")


def run_maintenance() -> None:
    """
    Runs the settings menu for the application, delegates duties depending 
    on what the user selects to do, current choices are:
      - 1. Updating the database 
      - 2. Retrain models
      - 3. Exiting to the main menu
    """
    options:int = 3
    while True:
        print_maintenance_menu()
        choice = get_menu_selection(options)
        if choice == 1:
            for tf in ["15", "60", "240", "D", "W"]:
                dbm = DatabaseManager("BTCUSDT", tf) 
                dbm.update_table()
            input("\n>> Hit enter to continue")
        elif choice == 2:
            # Print out a list of all models and the last time they were updated
            # Allow retraining on any or model
            print("Feature currently under construction")
            input("\n>> Hit enter to continue")
        else:
            return;


# Global settings for the program, make these persistance with a config file
def print_settings_menu() -> None:
    """ Prints the settings menu for the app """
    print_banner("SETTINGS")
    print("1. Change account name")
    print("2. Manage API keys")
    print("3. Scheduler")
    print("4. Preferences")
    print("5. Return to main menu")


if __name__ == "__main__":
    pass


main_menu: str = """\n
1. Manage account
2. Predict (manual)
3. Start engine
4. Stop engine
5. View Dashboard
6. Maintenance
7. Settings
8. Exit"""

account_management_menu: str = """"""
prediction_menu: str = """

"""
